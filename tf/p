#!/usr/bin/env bash
set -euo pipefail

# v — list VISIT targets from Terraform files in the current directory (flat)
# Usage: ./v <number>
# Notes:
#   - If <number> is a single digit, it is zero-padded (e.g., 1 -> 01)
#   - Only scans files in the current working directory (no subdirectories)
#   - Looks for files named like ${NN}*.tf and extracts text after the word VISIT

if [ $# -ne 1 ]; then
  echo "Usage: ./v <number>" >&2
  exit 1
fi

arg="$1"
# Normalize to two digits if single digit
if [[ "$arg" =~ ^[0-9]$ ]]; then
  num=$(printf "%02d" "$arg")
else
  num="$arg"
fi

# Enable nullglob so unmatched globs expand to nothing
shopt -s nullglob

# Build the file list in current directory (flat only)
files=( ./${num}*.tf )

# If no matching files, exit quietly
if [ ${#files[@]} -eq 0 ]; then
  exit 0
fi

# Grep for VISIT and extract the content after the word; sort alphabetically
# If there are no VISIT lines, grep exits 1 — we neutralize it with '|| true'
grep -h -F -w "VISIT" -- "${files[@]}" || true |
  sed -n 's/.*VISIT[: -]*[[:space:]]*//p' |
  LC_ALL=C sort
